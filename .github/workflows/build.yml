name: Build LambdaNotes

on:
  push:
    branches: [ "main" ]
  release:
    types: [ created ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        # cache: true # Enable if go.sum exists

    - name: Build Backend
      working-directory: ./backend
      run: go build -o backend.exe main.go

    - name: Build Frontend
      working-directory: ./frontend
      run: mvn clean package -DskipTests

    - name: Prepare Input Directory
      run: |
        New-Item -ItemType Directory -Path installer_input -Force
        Copy-Item backend/backend.exe -Destination installer_input/
        Copy-Item frontend/target/lambdanotes-1.0-SNAPSHOT.jar -Destination installer_input/

    - name: Run jpackage (Create App Image)
      run: |
        jpackage `
          --name "LambdaNotes" `
          --input installer_input `
          --main-jar "lambdanotes-1.0-SNAPSHOT.jar" `
          --main-class "com.lambdanotes.Launcher" `
          --type app-image `
          --dest installer_output `
          --app-version "1.0.0"

    - name: Create Portable ZIP
      run: |
        Compress-Archive -Path installer_output/LambdaNotes -DestinationPath LambdaNotes-Portable.zip

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LambdaNotes-Portable
        path: LambdaNotes-Portable.zip

    - name: Upload Release Asset
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: LambdaNotes-Portable.zip
